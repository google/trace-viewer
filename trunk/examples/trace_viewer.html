<!DOCTYPE HTML>
<html>
<!--
Copyright (c) 2011 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<head i18n-values="dir:textdirection;">
<title>Simple Embedded Viewer</title>
<script src="../src/base.js"></script>
<style>
  .view {
    overflow: hidden;
    position: absolute;
    top: 40px;
    bottom: 0;
    left: 0;
    right: 0;
  }

</style>
</head>
<body>
  <div class="header">
  <select id="trace_file">
    <option value="simple_trace.json">simple trace</option>
    <option value="android_systrace.html">android systrace</option>
    <option value="async_begin_end.json">async begin/end</option>
    <option value="big_trace.json">big trace</option>
    <option value="huge_trace.json">huge trace</option>
    <option value="instance_counters.json">instance counters</option>
    <option value="lthi_cats.json">lthi cats</option>
    <option value="main_thread_has_unclosed_slices.json">
        main thread unclosed slices</option>
    <option value="tall_trace.json">tall trace</option>
    <option value="trivial_trace.json">trivial trace</option>
    <option value="v8.log">v8</option>
  </select>
  </div>

  <div class="main">
    <div class="view">
    </div>
  </div>

  <script>
  base.require('tracing.timeline_view');
  base.require('cc');
  </script>
  <script>
  'use strict';

  var timelineViewEl;

  function loadTraces(filenames, callback) {
    var traces = [];
    for (var i = 0; i < filenames.length; i++) {
      traces.push(undefined);
    }
    var numTracesPending = filenames.length;

    filenames.forEach(function(filename, i) {
      getAsync(filename, function(trace) {
        traces[i] = trace;
        numTracesPending--;
        if (numTracesPending == 0)
          callback(traces);
      });
    });
  }

  function getAsync(url, cb) {
    var req = new XMLHttpRequest();
    req.open('GET', url, true);
    req.onreadystatechange = function(aEvt) {
      if (req.readyState == 4) {
        window.setTimeout(function() {
          if (req.status == 200) {
            cb(req.responseText);
          } else {
            console.log('Failed to load ' + url);
          }
        }, 0);
      }
    };
    req.send(null);
  }

  function createViewFromTraces(traces) {
    var m = new tracing.Model();
    m.importTraces(traces, true);

    timelineViewEl = document.querySelector('.view');
    ui.decorate(timelineViewEl, tracing.TimelineView);
    timelineViewEl.model = m;
    timelineViewEl.tabIndex = 1;
    timelineViewEl.timeline.focusElement = timelineViewEl;
  }

  function onLoad() {
    var select = document.getElementById('trace_file');
    select.onchange = onLoad;

    var file = select[select.selectedIndex].value;
    var filenames = ['../test_data/' + file];
    loadTraces(filenames, createViewFromTraces);
  }

  document.addEventListener('DOMContentLoaded', onLoad);
  </script>
</body>
</html>
