<!DOCTYPE HTML>
<html>
<!--
Copyright (c) 2012 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<head>
<title>ProfilingView tests</title>
<script src="base.js"></script>
<style>
  .profiling-view {
    border: 1px solid black;
  }
</style>
</head>
<body>
<script>
'use strict';

base.defineModule('timeline_test')
    .dependsOn('unittest',
               'test_utils',
               'profiling_view')
    .runAllTests(function() {

    var tests = {};

    /*
     * Just enough of the TracingController to support the tests below.
     */
    function FakeTracingController() {
    }

    FakeTracingController.prototype = {
      __proto__: base.EventTarget.prototype,

      beginTracing: function(opt_systemTracingEnabled) {
        this.wasBeginTracingCalled = true;
        this.wasBeginTracingCalledWithSystemTracingEnabled = opt_systemTracingEnabled;
      },

      get traceEvents() {
        if (!this.wasBeginTracingCalled)
          return undefined;
        return FakeTracingController.testData;
      },

      get systemTraceEvents() {
        if (!this.wasBeginTracingCalled)
          return [];
        if (!this.wasBeginTracingCalledWithSystemTracingEnabled)
          return [];
        return FakeTracingController.systemTraceTestData;
      }

    };
    FakeTracingController.testData = [
      {name: 'a', args: {}, pid: 52, ts: 520, cat: 'foo', tid: 53, ph: 'B'},
      {name: 'a', args: {}, pid: 52, ts: 560, cat: 'foo', tid: 53, ph: 'E'},
      {name: 'b', args: {}, pid: 52, ts: 629, cat: 'foo', tid: 53, ph: 'B'},
      {name: 'b', args: {}, pid: 52, ts: 631, cat: 'foo', tid: 53, ph: 'E'}
    ];
    FakeTracingController.systemTraceTestData = [
      'systrace.sh-8170  [001] 15180.978813: sched_switch: ' +
                'prev_comm=systrace.sh prev_pid=8170 prev_prio=120 ' +
                'prev_state=x ==> next_comm=kworker/1:0 next_pid=7873 ' +
                'next_prio=120',
      ' kworker/1:0-7873  [001] 15180.978836: sched_switch: ' +
                'prev_comm=kworker/1:0 prev_pid=7873 prev_prio=120 ' +
                'prev_state=S ==> next_comm=debugd next_pid=4404 next_prio=120',
      '     debugd-4404  [001] 15180.979010: sched_switch: prev_comm=debugd ' +
                'prev_pid=4404 prev_prio=120 prev_state=S ==> ' +
                'next_comm=dbus-daemon next_pid=510 next_prio=120',
      'systrace.sh-8182  [000] 15186.203900: tracing_mark_write: ' +
                'trace_event_clock_sync: parent_ts=0.0'
    ].join('\n');

    /* This test just instantiates a ProflingView and adds it to the DOM
     * to help with non-unittest UI work.
     */
    tests.testInstantiate = function() {
      var view = new tracing.ProfilingView();
      view.tracingController = new FakeTracingController();
      view.focusElement = view;
      document.body.appendChild(view);
    }

    function recordTestCommon() {
      var view = new tracing.ProfilingView();
      var tracingController = new FakeTracingController()
      view.tracingController = tracingController;
      view.querySelector('button.record').click();
      assertTrue(tracingController.wasBeginTracingCalled);
      assertEquals(base.isChromeOS,
                   tracingController.wasBeginTracingCalledWithSystemTracingEnabled);

      var e = new base.Event('traceEnded');
      var didRefresh = false;
      e.events = tracingController.traceEvents;
      tracingController.dispatchEvent(e);
      assertTrue(!!view.timelineView.model);
    }

    tests.testRecordNonCros = function() {
      var old = base.isChromeOS;
      base.isChromeOS = false;
      try {
        recordTestCommon();
      } finally {
        base.isChromeOS = old;
      }
    }

    tests.testRecordCros = function() {
      var old = base.isChromeOS;
      base.isChromeOS = true;
      try {
        recordTestCommon();
      } finally {
        base.isChromeOS = old;
      }
    }
    return tests;
});
  </script>
</body>
</html>
