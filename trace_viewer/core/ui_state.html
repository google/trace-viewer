<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/core/location.html">

<script>
'use strict';

tv.exportTo('tv.c', function() {
  var Location = tv.c.Location;

  /**
   * UIState is a class that represents the current state of the timeline by
   * the Location of the point of interest and the current scaleX of the
   * timeline.
   *
   * @constructor
   */
  function UIState(location, scaleX) {
    this.location_ = location;
    this.scaleX_ = scaleX;
  };

  /**
   * Accepts a UIState string in the format of (timestamp)@(pid).(tid)x(scaleX)
   * Returns undefined if string is not in this format, or returns an Error if
   * accepted variables in string does not produce a valid UIState. Otherwise
   * returns a constructed UIState instance.
   */
  UIState.fromUserFriendlyString = function(viewport, stateString) {
    var navByFinderPattern = /^(\d+(\.\d+)?)@(\d+)\.(\d+)x(\d+(\.\d+)?)$/g;
    var match = navByFinderPattern.exec(stateString);
    if (!match)
      return;

    var timestamp = Number(match[1]);
    var pid = match[3];
    var tid = match[4];
    var scaleX = Number(match[5]);
    var loc = tv.c.Location.fromStableIdAndTimestamp(
        viewport, pid + '.' + tid, timestamp);

    if (timestamp < 0 || pid < 0 || tid < 0 || scaleX <= 0)
      return new Error('Invalid UI State variable values.');

    // Location.fromStableIdAndTimestamp will return undefined if the stableId
    // for pid and tid is not found in our model. In that case we cannot
    // construct a UIState for that string so we return an error.
    if (!loc)
      return new Error('PID/TID was not found in our model.');

    return new UIState(loc, scaleX);
  }

  UIState.prototype = {

    get location() {
      return this.location_;
    },

    get scaleX() {
      return this.scaleX_;
    },

    toJSON: function() {
      var obj = new Object();
      var keys = Object.keys(this);
      for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        if (typeof this[key] === 'function')
          continue;
        obj[key] = this[key];
      }
      return obj;
    }
  };

  return {
    UIState: UIState
  };
});
</script>
