<!DOCTYPE html>
<!--
Copyright (c) 2013 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/extras/about_tracing/record_selection_dialog.html">
<link rel="import" href="/base/settings.html">
<link rel="import" href="/core/test_utils.html">

<script>
'use strict';

tv.b.unittest.testSuite(function() { // @suppress longLineCheck
  test('instantitate', function() {
    var categories = [];
    for (var i = 0; i < 30; i++)
      categories.push('cat-' + i);
    for (var i = 0; i < 20; i++)
      categories.push('disabled-by-default-cat-' + i);
    categories.push('really-really-really-really-really-really-very-loong-cat');
    categories.push('first,second,third');
    categories.push('cc,disabled-by-default-cc.debug');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = categories;
    dlg.settings_key = 'key';
    dlg.currentlyChosenPreset = [];

    var showButton = document.createElement('button');
    showButton.textContent = 'Show record selection dialog';
    showButton.addEventListener('click', function(e) {
      dlg.visible = true;
      e.stopPropagation();
    });
    this.addHTMLOutput(showButton);
  });

  test('recordSelectionDialog_splitCategories', function() {
    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories =
        ['cc,disabled-by-default-one,cc.debug', 'two,three', 'three'];
    dlg.settings_key = 'key';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    var expected =
        ['"cc"', '"cc.debug"', '"disabled-by-default-one"', '"three"', '"two"'];

    var labels = dlg.querySelectorAll('.categories input');
    var results = [];
    for (var i = 0; i < labels.length; i++) {
      results.push('"' + labels[i].value + '"');
    }
    results = results.sort();

    assertArrayEquals(expected, results);
  });

  test('recordSelectionDialog_UpdateForm_NoSettings', function() {
    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one', 'two', 'three'];
    dlg.settings_key = 'key';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    var checkboxes = dlg.querySelectorAll('.categories input');
    assertEquals(3, checkboxes.length);
    assertEquals('three', checkboxes[0].id);
    assertEquals('three', checkboxes[0].value);
    assertEquals(true, checkboxes[0].checked);
    assertEquals('two', checkboxes[1].id);
    assertEquals('two', checkboxes[1].value);
    assertEquals(true, checkboxes[1].checked);
    assertEquals('disabled-by-default-one', checkboxes[2].id);
    assertEquals('disabled-by-default-one', checkboxes[2].value);
    assertEquals(false, checkboxes[2].checked);

    assertEquals('', dlg.categoryFilter());

    var labels = dlg.querySelectorAll('.categories label');
    assertEquals(3, labels.length);
    assertEquals('three', labels[0].textContent);
    assertEquals('two', labels[1].textContent);
    assertEquals('one', labels[2].textContent);
  });

  test('recordSelectionDialog_UpdateForm_Settings', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    var checkboxes = dlg.querySelectorAll('.categories input');
    assertEquals(3, checkboxes.length);
    assertEquals('three', checkboxes[0].id);
    assertEquals('three', checkboxes[0].value);
    assertEquals(false, checkboxes[0].checked);
    assertEquals('two', checkboxes[1].id);
    assertEquals('two', checkboxes[1].value);
    assertEquals(true, checkboxes[1].checked);
    assertEquals('disabled-by-default-one', checkboxes[2].id);
    assertEquals('disabled-by-default-one', checkboxes[2].value);
    assertEquals(false, checkboxes[2].checked);

    assertEquals('-three', dlg.categoryFilter());

    var labels = dlg.querySelectorAll('.categories label');
    assertEquals(3, labels.length);
    assertEquals('three', labels[0].textContent);
    assertEquals('two', labels[1].textContent);
    assertEquals('one', labels[2].textContent);
  });

  test('recordSelectionDialog_UpdateForm_DisabledByDefault', function() {
    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-bar', 'baz'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    assertEquals('', dlg.categoryFilter());

    var inputs =
        dlg.querySelector('input#disabled-by-default-bar').click();

    assertEquals('disabled-by-default-bar', dlg.categoryFilter());

    assertEquals(false,
        tv.b.Settings.get('disabled-by-default-foo', false, 'categories'));
  });

  test('recordSelectionDialog_changeActiveTab', function() {
    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    // Default display is Presets tab.
    dlg.categories = ['one', 'two', 'three'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = ['one'];
    dlg.updateForm_();

    assertEquals(true, dlg.showingPresetTab_());
    dlg.querySelector('.labeled-option-customize').click();
    assertEquals(false, dlg.showingPresetTab_());
    dlg.querySelector('tab-strip-label').click();
    assertEquals(true, dlg.showingPresetTab_());

    // Default display is Advanced tab.
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    assertEquals(false, dlg.showingPresetTab_());
    dlg.querySelector('tab-strip-label').click();
    assertEquals(true, dlg.showingPresetTab_());
    dlg.querySelector('.labeled-option-customize').click();
    assertEquals(false, dlg.showingPresetTab_());
  });

  test('recordSelectionDialog_checkPresetCustomizeState', function() {
    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['one', 'two', 'three'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = ['one'];
    dlg.updateForm_();

    var inputs = dlg.querySelectorAll('.labeled-option-customize');
    // In presets mode, customize button should be active only for the
    // selected preset option. Rest all cutomize buttons should be disabled.
    assertEquals(false, inputs[0].disabled);
    for (var i = 1; i < inputs.length; ++i)
      assertEquals(true, inputs[i].disabled);
  });

  test('selectAll', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();
  });

  test('selectNone', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    // Enables the three option, two already enabled.
    dlg.querySelector('.default-enabled-categories .all-btn').click();
    assertEquals('', dlg.categoryFilter());
    assertEquals(true, tv.b.Settings.get('three', false, 'categories'));

    // Disables three and two.
    dlg.querySelector('.default-enabled-categories .none-btn').click();
    assertEquals('-three,-two', dlg.categoryFilter());
    assertEquals(false, tv.b.Settings.get('two', false, 'categories'));
    assertEquals(false, tv.b.Settings.get('three', false, 'categories'));

    // Turn categories back on so they can be ignored.
    dlg.querySelector('.default-enabled-categories .all-btn').click();

    // Enables disabled category.
    dlg.querySelector('.default-disabled-categories .all-btn').click();
    assertEquals('disabled-by-default-one', dlg.categoryFilter());
    assertEquals(true,
        tv.b.Settings.get('disabled-by-default-one', false, 'categories'));

    // Turn disabled by default back off.
    dlg.querySelector('.default-disabled-categories .none-btn').click();
    assertEquals('', dlg.categoryFilter());
    assertEquals(false,
        tv.b.Settings.get('disabled-by-default-one', false, 'categories'));
  });

  test('recordSelectionDialog_defaultPreset', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    // Note: currentlyChosenPreset is not set here, so the default is used.
    dlg.updateForm_();

    // Make sure the default filter is returned.
    assertEquals('-three,-two', dlg.categoryFilter());

    // Make sure the default tracing types are returned.
    assertEquals(true, dlg.useContinuousTracing);
    assertEquals(false, dlg.useSystemTracing);
    assertEquals(false, dlg.useSampling);

    // Make sure the manual settings are not visible.
    var classList = dlg.categoriesView_.classList;
    assertEquals(true, classList.contains('categories-column-view-hidden'));
    assertEquals(false,
        dlg.presetsEl_.classList.contains('category-presets-hidden'));
    var descClasslist = dlg.querySelector('.category-description').classList;
    assertEquals(false, descClasslist.contains('category-description-hidden'));

    // Verify manual settings do not modify the checkboxes.
    var checkboxes = dlg.querySelectorAll('.categories input');
    assertEquals(3, checkboxes.length);
    assertEquals('three', checkboxes[0].id);
    assertEquals('three', checkboxes[0].value);
    assertEquals(false, checkboxes[0].checked);
    assertEquals('two', checkboxes[1].id);
    assertEquals('two', checkboxes[1].value);
    assertEquals(true, checkboxes[1].checked);
    assertEquals('disabled-by-default-one', checkboxes[2].id);
    assertEquals('disabled-by-default-one', checkboxes[2].value);
    assertEquals(false, checkboxes[2].checked);
  });

  test('recordSelectionDialog_changePresets', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');
    tv.b.Settings.set('disabled-by-default-cc.debug', true, 'categories');
    tv.b.Settings.set('recordSelectionDialog.useContinuousTracing', false);
    tv.b.Settings.set('recordSelectionDialog.useSystemTracing', true);
    tv.b.Settings.set('recordSelectionDialog.useSampling', false);

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    // Note: currentlyChosenPreset is not set here, so the default is used.
    dlg.updateForm_();

    // Make sure the default filter is returned.
    assertEquals('-three,-two',
        dlg.categoryFilter());

    // Make sure the default tracing types are returned.
    assertEquals(true, dlg.useContinuousTracing);
    assertEquals(false, dlg.useSystemTracing);
    assertEquals(false, dlg.useSampling);

    // Make sure the manual settings are not visible.
    var classList = dlg.categoriesView_.classList;
    assertEquals(true, classList.contains('categories-column-view-hidden'));

    // Switch to manual settings and verify the default values are not returned.
    dlg.currentlyChosenPreset = [];
    assertEquals('-three,disabled-by-default-cc.debug', dlg.categoryFilter());
    assertEquals(false, dlg.useContinuousTracing);
    assertEquals(true, dlg.useSystemTracing);
    assertEquals(false, dlg.useSampling);
    assertEquals(false, classList.contains('categories-column-view-hidden'));
    assertEquals(true,
        dlg.presetsEl_.classList.contains('category-presets-hidden'));
    var descClasslist = dlg.querySelector('.category-description').classList;
    assertEquals(true, descClasslist.contains('category-description-hidden'));

    // Switch to the graphics, rendering, and rasterization preset.
    dlg.currentlyChosenPreset = ['blink', 'cc', 'renderer',
      'disabled-by-default-cc.debug'];
    assertEquals('disabled-by-default-cc.debug,-three,-two',
        dlg.categoryFilter());
  });

  test('recordSelectionDialog_savedPreset', function() {
    tv.b.Settings.set('two', true, 'categories');
    tv.b.Settings.set('three', false, 'categories');
    tv.b.Settings.set('recordSelectionDialog.useContinuousTracing', true);
    tv.b.Settings.set('recordSelectionDialog.useSystemTracing', true);
    tv.b.Settings.set('recordSelectionDialog.useSampling', true);
    tv.b.Settings.set('tv.e.about_tracing.record_selection_dialog_preset',
        ['blink', 'cc', 'renderer', 'cc.debug']);

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.categories = ['disabled-by-default-one'];
    dlg.settings_key = 'categories';
    dlg.updateForm_();

    // Make sure the correct filter is returned.
    assertEquals('-three,-two', dlg.categoryFilter());

    // Make sure the correct tracing types are returned.
    assertEquals(true, dlg.useContinuousTracing);
    assertEquals(false, dlg.useSystemTracing);
    assertEquals(false, dlg.useSampling);

    // Make sure the manual settings are not visible.
    var classList = dlg.categoriesView_.classList;
    assertEquals(true, classList.contains('categories-column-view-hidden'));

    // Switch to manual settings and verify the default values are not returned.
    dlg.currentlyChosenPreset = [];
    assertEquals('-three', dlg.categoryFilter());
    assertEquals(true, dlg.useContinuousTracing);
    assertEquals(true, dlg.useSystemTracing);
    assertEquals(true, dlg.useSampling);
    assertEquals(false, classList.contains('categories-column-view-hidden'));
  });

  test('recordSelectionDialog_categoryFilters', function() {
    tv.b.Settings.set('default1', true, 'categories');
    tv.b.Settings.set('disabled1', false, 'categories');
    tv.b.Settings.set('disabled-by-default-cc.disabled2', false, 'categories');
    tv.b.Settings.set('input', true, 'categories');
    tv.b.Settings.set('blink', true, 'categories');
    tv.b.Settings.set('cc', false, 'categories');
    tv.b.Settings.set('disabled-by-default-cc.debug', true, 'categories');

    var dlg = new tv.e.about_tracing.RecordSelectionDialog();
    dlg.settings_key = 'categories';
    dlg.categories = [];
    dlg.currentlyChosenPreset = [];
    dlg.updateForm_();

    assertEquals('-cc,-disabled1,disabled-by-default-cc.debug',
        dlg.categoryFilter());

    // Switch to the graphics, rendering, and rasterization preset.
    dlg.currentlyChosenPreset = ['blink', 'cc', 'renderer',
      'disabled-by-default-cc.debug'];
    assertEquals('-default1,disabled-by-default-cc.debug,-disabled1,-input',
        dlg.categoryFilter());
  });
});
</script>
